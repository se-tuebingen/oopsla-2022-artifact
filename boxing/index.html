<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <title>Boxing and Unboxing - System C</title> <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <link rel="stylesheet" href="/highlight/styles/github-gist.css"> <script type="text/javascript" src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.7.1 --> <title>Boxing and Unboxing | System C</title> <meta name="generator" content="Jekyll v4.0.1" /> <meta property="og:title" content="Boxing and Unboxing" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="This is the artifact acompanying paper #53 on System C." /> <meta property="og:description" content="This is the artifact acompanying paper #53 on System C." /> <meta property="og:site_name" content="System C" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Boxing and Unboxing" /> <script type="application/ld+json"> {"description":"This is the artifact acompanying paper #53 on System C.","url":"/boxing/","@type":"WebPage","headline":"Boxing and Unboxing","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="/" class="site-title lh-tight"> System C </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/" class="nav-list-link">Home</a></li><li class="nav-list-item"><a href="/intro/" class="nav-list-link">Basics</a></li><li class="nav-list-item"><a href="/capability/" class="nav-list-link">Capabilities</a></li><li class="nav-list-item active"><a href="/boxing/" class="nav-list-link active">Boxing and Unboxing</a></li><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/paper.html" class="nav-list-link">Paper Examples</a><ul class="nav-list "><li class="nav-list-item "><a href="/paper/section1.html" class="nav-list-link">Section 1</a></li><li class="nav-list-item "><a href="/paper/section2.html" class="nav-list-link">Section 2</a></li><li class="nav-list-item "><a href="/paper/section4.html" class="nav-list-link">Section 4</a></li></ul></li><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/casestudies.html" class="nav-list-link">Case Studies</a><ul class="nav-list "><li class="nav-list-item "><a href="/casestudies/passthrough.html" class="nav-list-link">Use and Mention</a></li><li class="nav-list-item "><a href="/casestudies/regions.html" class="nav-list-link">Region-based Local State</a></li><li class="nav-list-item "><a href="/casestudies/scheduler.html" class="nav-list-link">Scheduling (with continuations and mutable cells)</a></li></ul></li></ul> </nav> <footer class="site-footer"> This artifact uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> </div> <div id="main-content-wrap" class="main-content-wrap"> <div id="main-content" class="main-content" role="main"> <h1 id="boxing-and-unboxing"> <a href="#boxing-and-unboxing" class="anchor-heading" aria-labelledby="boxing-and-unboxing"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Boxing and Unboxing </h1> <p>As we observed earlier, by default functions and capabilites are second class – they cannot be returned nor stored in mutable cells and can only be passed as second-class parameters to other functions. We can lift this restriction by <em>boxing</em> these functions and capabilities, reifying the set of captured capabilites from the binder to the type.</p><pre><code class="language-effekt">interface Greeter { def sayHello(): Unit }

def myGreeter() {
  try {
    // boxing a capability and storing it in a mutable variable
    var capturedGreeter = box greeter;

    // unboxing requires `greeter` to be in scope
    def user() { (unbox capturedGreeter).sayHello() }

    // automatic boxing of `user`, stored in a value binder
    val firstClassUser: () =&gt; Unit at {greeter} = user;

    // automatic unboxing of firstClassUser
    firstClassUser()
  } with greeter : Greeter {
    def sayHello() { println("Hello World!"); resume(()) }
  }
}
</code></pre><p>Here, we box <code class="highlighter-rouge">greeter</code> to store it in the mutable cell <code class="highlighter-rouge">capturedGreeter</code>. Note that System C supports automatic boxing and unboxing, and we could have omitted <code class="highlighter-rouge">box</code>. We can also explicitly annotate the expected capability set as <code class="highlighter-rouge">box {greeter} greeter</code>. In the function <code class="highlighter-rouge">user</code>, we unbox the captured first-class block and call <code class="highlighter-rouge">sayHello</code>. The fact that we unbox it is reflected in the inferred capability set annotated on <code class="highlighter-rouge">user</code>.</p> <p>Boxed values act as normal first-class values in System C until unboxed. In particular, they can be passed as values to value-polymorphic functions.</p><pre><code class="language-effekt">def invoke[T](v : T){f : (T) =&gt; Unit}: Unit { f(v) }

def indirectMyGreeter { greeter: Greeter }: Unit {
  val capturedGreeter = box greeter;
  invoke(capturedGreeter){ (f : Greeter at { greeter }) =&gt;
    f.sayHello()
  }
}
</code></pre><p>Hovering over <code class="highlighter-rouge">capturedGreeter</code> shows how the capture is reflected in the type.</p> <h2 id="reasoning-about-purity"> <a href="#reasoning-about-purity" class="anchor-heading" aria-labelledby="reasoning-about-purity"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Reasoning about Purity </h2> <p>Boxes reflect capture of tracked variables in their types. Let us assume the following function in the standard library:</p><pre><code class="language-effekt">// def setTimeout(callback: () =&gt; Unit at {}, duration: Int): Unit
</code></pre><p>Its implementation uses the FFI to JavaScript. System C is implemented as a compiler to JavaScript and requires a monadic runtime. The value passed to the JavaScript builtin <code class="highlighter-rouge">window.setTimeout</code> should not make use of any control effects or effect handlers since it will be called later outside of all possible handlers. To express this, we require the callback to be “pure” (i.e. <code class="highlighter-rouge">() =&gt; Unit at {}</code>).</p> <p>We can still use the unsafe <code class="highlighter-rouge">println</code> function, as illustrated in the following example</p><pre><code class="language-effekt:repl">setTimeout(box { () =&gt; println("Hello after 2 seconds!") }, 2000)
</code></pre></div> </div> </div> <script src="/highlight/highlight.pack.js"></script> <script src="/dist/app.bundle.js"></script> </body> </html>
