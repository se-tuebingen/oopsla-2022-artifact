<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <title>Scheduling (with continuations and mutable cells) - System C</title> <link rel="shortcut icon" href="/oopsla-2022-artifact/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/oopsla-2022-artifact/assets/css/just-the-docs-default.css"> <link rel="stylesheet" href="/oopsla-2022-artifact/highlight/styles/github-gist.css"> <script type="text/javascript" src="/oopsla-2022-artifact/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.7.1 --> <title>Scheduling (with continuations and mutable cells) | System C</title> <meta name="generator" content="Jekyll v4.0.1" /> <meta property="og:title" content="Scheduling (with continuations and mutable cells)" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="This is the artifact acompanying the paper ‘Effects, Capabilities, and Boxes’." /> <meta property="og:description" content="This is the artifact acompanying the paper ‘Effects, Capabilities, and Boxes’." /> <meta property="og:site_name" content="System C" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Scheduling (with continuations and mutable cells)" /> <script type="application/ld+json"> {"headline":"Scheduling (with continuations and mutable cells)","description":"This is the artifact acompanying the paper ‘Effects, Capabilities, and Boxes’.","url":"/oopsla-2022-artifact/casestudies/scheduler.html","@type":"WebPage","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="/oopsla-2022-artifact/" class="site-title lh-tight"> System C </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/oopsla-2022-artifact/" class="nav-list-link">Home</a></li><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/oopsla-2022-artifact/tutorial/" class="nav-list-link">Tutorial</a><ul class="nav-list "><li class="nav-list-item "><a href="/oopsla-2022-artifact/intro/" class="nav-list-link">Basics</a></li><li class="nav-list-item "><a href="/oopsla-2022-artifact/capability/" class="nav-list-link">Capabilities</a></li><li class="nav-list-item "><a href="/oopsla-2022-artifact/boxing/" class="nav-list-link">Boxing and Unboxing</a></li></ul></li><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/oopsla-2022-artifact/proofs/" class="nav-list-link">Proofs</a><ul class="nav-list "><li class="nav-list-item "><a href="/oopsla-2022-artifact/proofs/Top.SystemC.CaptureSets.html" class="nav-list-link">CaptureSets</a></li><li class="nav-list-item "><a href="/oopsla-2022-artifact/proofs/Top.SystemC.Definitions.html" class="nav-list-link">Definitions</a></li><li class="nav-list-item "><a href="/oopsla-2022-artifact/proofs/Top.SystemC.Examples.html" class="nav-list-link">Examples</a></li><li class="nav-list-item "><a href="/oopsla-2022-artifact/proofs/Top.SystemC.Infrastructure.html" class="nav-list-link">Infrastructure</a></li><li class="nav-list-item "><a href="/oopsla-2022-artifact/proofs/Top.SystemC.Lemmas.html" class="nav-list-link">Lemmas</a></li><li class="nav-list-item "><a href="/oopsla-2022-artifact/proofs/Top.SystemC.Soundness.html" class="nav-list-link">Soundness</a></li><li class="nav-list-item "><a href="/oopsla-2022-artifact/proofs/Top.SystemC.Substitution.html" class="nav-list-link">Substitution</a></li></ul></li><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/oopsla-2022-artifact/paper.html" class="nav-list-link">Paper Examples</a><ul class="nav-list "><li class="nav-list-item "><a href="/oopsla-2022-artifact/paper/section1.html" class="nav-list-link">Section 1</a></li><li class="nav-list-item "><a href="/oopsla-2022-artifact/paper/section2.html" class="nav-list-link">Section 2</a></li><li class="nav-list-item "><a href="/oopsla-2022-artifact/paper/section4.html" class="nav-list-link">Section 4</a></li></ul></li><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/oopsla-2022-artifact/casestudies.html" class="nav-list-link">Case Studies</a><ul class="nav-list "><li class="nav-list-item "><a href="/oopsla-2022-artifact/casestudies/passthrough.html" class="nav-list-link">Use and Mention</a></li><li class="nav-list-item "><a href="/oopsla-2022-artifact/casestudies/regions.html" class="nav-list-link">Region-based Local State</a></li><li class="nav-list-item active"><a href="/oopsla-2022-artifact/casestudies/scheduler.html" class="nav-list-link active">Scheduling (with continuations and mutable cells)</a></li></ul></li></ul> </nav> <footer class="site-footer"> This artifact uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> </div> <div id="main-content-wrap" class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="/oopsla-2022-artifact/casestudies.html">Case Studies</a></li> <li class="breadcrumb-nav-list-item"><span>Scheduling (with continuations and mutable cells)</span></li> </ol> </nav> <div id="main-content" class="main-content" role="main"> <h2 id="scheduling-tasks-and-continuations"> <a href="#scheduling-tasks-and-continuations" class="anchor-heading" aria-labelledby="scheduling-tasks-and-continuations"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Scheduling Tasks and Continuations </h2> <p>Writing a safe, co-operatively threaded scheduler in an effect safe manner can be hard, as it requires treating continuations as first-class values. Continuations might indirectly close over other capabilities and we want to prevent that capabilities leave their defining scope indirectly through continuations. System C can safely express this though – the following is a skeleton of a scheduler.</p><pre><code class="language-effekt">import immutable/list

// we first draft a naive implementation of a queue
def emptyQueue[T]() { Nil[T]() }
def enqueue[T](q: List[T], el: T): List[T] { Cons(el, q) }
def nonEmpty[T](q: List[T]) { size(q) &gt; 0 }
def dequeue[T](q: List[T]) { reverse(q) match {
  case Nil() =&gt; panic[(List[T], T)]("Empty queue")
  case Cons(hd, tl) =&gt; (reverse(tl), hd)
}}

// now we define the interface of our scheduler
interface Proc { def fork(): Boolean }

// and implement the scheduler itself
def schedule { p: { Proc } =&gt; Unit }: Unit {
  // "processes" spawned by fork are stored in this local mutable cell
  var q: List[() =&gt; Unit at {p, schedule}] = emptyQueue();

  // we run the program with our own scheduler
  try { p {proc} } with proc: Proc {
    // forking enqueues the continuation twice
    def fork() { q = enqueue(q, box { () =&gt; resume(true) });
                 q = enqueue(q, box { () =&gt; resume(false) }) }
  };

  // finally, while there are continuations, we dequeue and force them
  while (nonEmpty(q)) {
    dequeue(q) match {
      case (rest, k) =&gt;
        // this "type-ascription" is necessary due to our preliminary
        // implementation of local type inference for matches
        val k2: () =&gt; Unit at {p, schedule} = k;
        q = rest;

        // force the continuation
        (unbox k2)()
    }
  }
}


// Example using the scheduler
interface Exc { def abort(): Unit }
def example() {
  try {
    schedule { {p:Proc} =&gt;
      if (p.fork()) {
        println("(1)");
        if (p.fork()) {
          println("(2)"); exc.abort()
        } else { println("(3)") }
      } else { println("(4)") }
    }
  } with exc: Exc { def abort() { println("aborted") }}
}
</code></pre><p>Note how the use of local mutable state is safely encapsulated in function <code class="highlighter-rouge">schedule</code>, which does not close over anything. We can run the above example, which forks two threads and aborts with an outer capability:</p><pre><code class="language-effekt:repl">example()
</code></pre><p>Here, <code class="highlighter-rouge">schedule</code> takes in a program which expects a given <code class="highlighter-rouge">Proc</code> capability. As this program is a second-class argument, it can use additional capabilities that are not reflected in its type (but are on its binder) due to System C’s contextual effect polymorphism. In particular, these capabilities may be captured on the continuation term <code class="highlighter-rouge">resume</code>. However, as those capabilities are second class, they cannot leak through the resumption and the entire program is safe – in particular, the resumption cannot leak even though it is stored in the mutable cell <code class="highlighter-rouge">q</code>, as <code class="highlighter-rouge">q</code> is second-class itself and valid only within the context of the <code class="highlighter-rouge">scheduler</code> region.</p> <p>In the example above, calling <code class="highlighter-rouge">exc.abort()</code> not only terminates one “thread”, but the scheduler as a whole. This is the expected behavior: The handler for exceptions is located <em>outside</em> of the scheduler and thus the continuation captured and discarded by <code class="highlighter-rouge">abort</code> also includes the scheduler itself.</p> </div> </div> </div> <script src="/oopsla-2022-artifact/highlight/highlight.pack.js"></script> <script src="/oopsla-2022-artifact/dist/app.bundle.js"></script> </body> </html>
